varnishtest "unset bereq.body tests"

server s1 {
	rxreq
	expect req.method == "GET"
	expect req.url == "/cached"
	expect req.http.Content-Length == <undef>
	txresp

	rxreq
	expect req.method == "GET"
	expect req.url == "/cachednobody"
	expect req.http.Content-Length == <undef>
	txresp
} -start

varnish v1 -vcl+backend {
	import std;

	sub vcl_recv {
		if (req.url == "/cached") {
			std.cache_req_body(2KB);
		}
	}
	sub vcl_backend_fetch {
		unset bereq.body;
	}
} -start

client c1 {
	txreq -url "/cached" -body "fine"
	rxresp
	expect resp.status == 200

	txreq -url "/cachednobody"
	rxresp
	expect resp.status == 200
} -run
